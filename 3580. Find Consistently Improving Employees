Problem:

Table: employees

+-------------+---------+
| Column Name | Type    |
+-------------+---------+
| employee_id | int     |
| name        | varchar |
+-------------+---------+
employee_id is the unique identifier for this table.
Each row contains information about an employee.
Table: performance_reviews

+-------------+------+
| Column Name | Type |
+-------------+------+
| review_id   | int  |
| employee_id | int  |
| review_date | date |
| rating      | int  |
+-------------+------+
review_id is the unique identifier for this table.
Each row represents a performance review for an employee. The rating is on a scale of 1-5 where 5 is excellent and 1 is poor.
Write a solution to find employees who have consistently improved their performance over their last three reviews.

An employee must have at least 3 review to be considered
The employee's last 3 reviews must show strictly increasing ratings (each review better than the previous)
Use the most recent 3 reviews based on review_date for each employee
Calculate the improvement score as the difference between the latest rating and the earliest rating among the last 3 reviews
Return the result table ordered by improvement score in descending order, then by name in ascending order.


Solution:
WITH ranked_reviews AS (
    SELECT
        pr.employee_id,
        pr.rating,
        pr.review_date,
        ROW_NUMBER() OVER (
            PARTITION BY pr.employee_id
            ORDER BY pr.review_date DESC
        ) AS rn
    FROM performance_reviews pr
),
last_three AS (
    SELECT
        employee_id,
        MAX(CASE WHEN rn = 1 THEN rating END) AS r1,
        MAX(CASE WHEN rn = 2 THEN rating END) AS r2,
        MAX(CASE WHEN rn = 3 THEN rating END) AS r3,
        COUNT(*) AS review_count
    FROM ranked_reviews
    WHERE rn <= 3
    GROUP BY employee_id
)
SELECT
    e.employee_id,
    e.name,
    (lt.r1 - lt.r3) AS improvement_score
FROM last_three lt
JOIN employees e
    ON e.employee_id = lt.employee_id
WHERE lt.review_count = 3
  AND lt.r3 < lt.r2
  AND lt.r2 < lt.r1
ORDER BY improvement_score DESC, e.name ASC;
