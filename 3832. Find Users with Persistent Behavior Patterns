Problem:
Table: activity

+--------------+---------+
| Column Name  | Type    |
+--------------+---------+
| user_id      | int     |
| action_date  | date    |
| action       | varchar |
+--------------+---------+
(user_id, action_date, action) is the primary key (unique value) for this table.
Each row represents a user performing a specific action on a given date.
Write a solution to identify behaviorally stable users based on the following definition:

A user is considered behaviorally stable if there exists a sequence of at least 5 consecutive days such that:
The user performed exactly one action per day during that period.
The action is the same on all those consecutive days.
If a user has multiple qualifying sequences, only consider the sequence with the maximum length.
Return the result table ordered by streak_length in descending order, then by user_id in ascending order.

Solution:

WITH DailyActions AS (
    SELECT user_id, action_date, action
    FROM activity
    GROUP BY user_id, action_date, action
    HAVING COUNT(*) = 1
),
Seqs AS (
    SELECT 
        user_id,
        action,
        action_date,
        DATE_SUB(action_date, INTERVAL ROW_NUMBER() OVER (
            PARTITION BY user_id, action ORDER BY action_date
        ) DAY) AS grp
    FROM DailyActions
),
Streaks AS (
    SELECT 
        user_id,
        action,
        MIN(action_date) AS start_date,
        MAX(action_date) AS end_date,
        COUNT(*) AS streak_length
    FROM Seqs
    GROUP BY user_id, action, grp
    HAVING COUNT(*) >= 5
)
SELECT user_id, action, streak_length, start_date, end_date
FROM (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY streak_length DESC) AS rn
    FROM Streaks
) t
WHERE rn = 1
ORDER BY streak_length DESC, user_id ASC;
