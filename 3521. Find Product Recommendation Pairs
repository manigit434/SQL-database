Problem:

Table: ProductPurchases

+-------------+------+
| Column Name | Type | 
+-------------+------+
| user_id     | int  |
| product_id  | int  |
| quantity    | int  |
+-------------+------+
(user_id, product_id) is the unique key for this table.
Each row represents a purchase of a product by a user in a specific quantity.
Table: ProductInfo

+-------------+---------+
| Column Name | Type    | 
+-------------+---------+
| product_id  | int     |
| category    | varchar |
| price       | decimal |
+-------------+---------+
product_id is the primary key for this table.
Each row assigns a category and price to a product.
Amazon wants to implement the Customers who bought this also bought... feature based on co-purchase patterns. Write a solution to :

Identify distinct product pairs frequently purchased together by the same customers (where product1_id < product2_id)
For each product pair, determine how many customers purchased both products
A product pair is considered for recommendation if at least 3 different customers have purchased both products.

Return the result table ordered by customer_count in descending order, and in case of a tie, by product1_id in ascending order, and then by product2_id in ascending order.

Solution:

WITH CoPurchases AS (
    -- Find all pairs of products bought by the same user
    SELECT
        pp1.user_id,
        pp1.product_id AS product1_id,
        pp2.product_id AS product2_id
    FROM
        ProductPurchases pp1
    JOIN
        ProductPurchases pp2 ON pp1.user_id = pp2.user_id
    WHERE
        -- Ensure product1_id < product2_id for distinct ordered pairs
        pp1.product_id < pp2.product_id
),
PairCounts AS (
    -- Count distinct customers for each product pair
    SELECT
        product1_id,
        product2_id,
        COUNT(DISTINCT user_id) AS customer_count
    FROM
        CoPurchases
    GROUP BY
        product1_id,
        product2_id
)
-- Final selection, filtering for at least 3 customers and joining with ProductInfo for categories
SELECT
    pc.product1_id,
    pc.product2_id,
    pi1.category AS product1_category,
    pi2.category AS product2_category,
    pc.customer_count
FROM
    PairCounts pc
JOIN
    ProductInfo pi1 ON pc.product1_id = pi1.product_id
JOIN
    ProductInfo pi2 ON pc.product2_id = pi2.product_id
WHERE
    pc.customer_count >= 3
ORDER BY
    pc.customer_count DESC,
    pc.product1_id ASC,
    pc.product2_id ASC;
